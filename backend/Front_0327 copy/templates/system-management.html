{% extends "base.html" %}
{% block title %}ì‹œìŠ¤í…œ ê´€ë¦¬{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/system-management.css') }}">
    <script src="{{ url_for('static', filename='js/system-management.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="form-container">
    <!-- ì—°ê²° ìƒíƒœ -->
    <div class="status-container">
        <div class="status-box">
            <h3>ğŸ“· ESP32 ê¸°ê¸°ì—°ê²° ìƒíƒœ</h3>
            <p class="status-good">ì—°ê²° ì–‘í˜¸</p>
        </div>
    </div>

    <!-- íƒ­ ë©”ë‰´ -->
<div class="tabs">
    <div class="tab active" onclick="showTab('request')">ì ê²€ ìš”ì²­í•˜ê¸°</div>
    <div class="tab" onclick="showTab('history')">ì ê²€ ìš”ì²­ ë‚´ì—­</div>
</div>

<form action="/apply_management" method="POST">
<div id="request" class="tab-content">
    <div class="form-section">
        <h2>ì ê²€ ë¶„ì•¼</h2>
        <div class="form-grid">
            <div class="radio-item">
                <input type="radio" id="check1" name="categoryIdx" value="1">
                <label for="check1">CNNëª¨ë¸ ì„±ëŠ¥ ì ê²€</label>
            </div>
            <div class="radio-item">
                <input type="radio" id="check2" name="categoryIdx" value="2">
                <label for="check2">ESP32 ì„±ëŠ¥ ì ê²€</label>
            </div>
            <div class="radio-item">
                <input type="radio" id="check3" name="categoryIdx" value="3">
                <label for="check3">ì‚¬ì´íŠ¸ ì ê²€</label>
            </div>
            <div class="radio-item">
                <input type="radio" id="check4" name="categoryIdx" value="4">
                <label for="check4">ê¸°íƒ€ ë¬¸ì˜</label>
            </div>
        </div>

        <h2>ìš”ì²­ ì •ë³´</h2>
        <div class="form-group">
            <label>íšŒì›ID</label>
            <input type="text" class="form-input" id="userid" name="userid" value="{{ user_info.userid }}" readonly="readonly">
        </div>

        <div class="form-group">
            <label>ì´ë©”ì¼</label>
            <div class="email-group">
                <input type="text" class="form-input" id="email" name="email" placeholder="ì•„ì´ë””" value="{{ user_info.userEmail.split('@')[0] }}">
                <span>@</span>
                <input type="text" class="form-input" id="emailDomain" name="emailDomain" placeholder="ë„ë©”ì¸" value="{{ user_info.userEmail.split('@')[1] }}" readonly>
                <select class="form-input" id="emailExt" style="width: 200px;">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="naver.com" {% if user_info.userEmail.endswith('@naver.com') %}selected{% endif %}>naver.com</option>
                    <option value="gmail.com" {% if user_info.userEmail.endswith('@gmail.com') %}selected{% endif %}>gmail.com</option>
                    <option value="hanmail.net" {% if user_info.userEmail.endswith('@hanmail.net') %}selected{% endif %}>hanmail.net</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€ ë¬¸ì˜</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>ì œëª©</label>
            <input type="text" class="form-input" id="applyTitle" name="applyTitle">
        </div>

        <div class="form-group">
            <label>ë‚´ìš©</label>
            <textarea class="form-input" rows="5" id="applyContent" name="applyContent"></textarea>
        </div>

        <div class="form-group">
            <label>íŒŒì¼ì²¨ë¶€</label>
            <div class="file-input-wrap">
                <label class="file-btn" for="file-upload">íŒŒì¼ ì„ íƒ</label>
                <input type="file" id="file-upload" name="applyFileName" style="display:none" onchange="showFileName()">
                <span id="fileName" class="file-name">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
            </div>
        </div>

        <div class="button-group">
            <button type="button" class="btn btn-cancel" onclick="resetForm()">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-submit" onclick="submitRequest(event)">ì œì¶œ</button>
        </div>
    </div>
</div>
{% if alert_message %}
<script type="text/javascript">
    alert("{{ alert_message }}");
</script>
{% endif %}
</form>

<!-- ì ê²€ ìš”ì²­ ë‚´ì—­ -->
<div id="history" class="tab-content" style="display:none;">
    <div class="form-section">
        <h2>ì ê²€ ìš”ì²­ ë‚´ì—­</h2>
        <table class="request-table" id="requestHistoryTable">
            <thead>
                <tr>
                    <th>ìš”ì²­ì¼ì</th>
                    <th>ì œëª©</th>
                    <th>ìƒíƒœ</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>2025-03-10</td>
                    <td>CNN ëª¨ë¸ ì„±ëŠ¥ ê°œì„  ìš”ì²­</td>
                    <td><span class="status-bad">ì²˜ë¦¬ì¤‘</span></td>
                </tr>
                <tr>
                    <td>2025-03-05</td>
                    <td>ESP32 íŒì›¨ì–´ ì—…ë°ì´íŠ¸</td>
                    <td><span class="status-good">ì™„ë£Œ</span></td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // íŒŒì¼ëª… í‘œì‹œ
        function showFileName() {
            const fileInput = document.getElementById('file-upload');
            const fileName = document.getElementById('fileName');
            if (fileInput.files.length > 0) {
                fileName.textContent = fileInput.files[0].name;
            } else {
                fileName.textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
            }
        }

        // í¼ ì´ˆê¸°í™”
        function resetForm() {
            document.querySelectorAll('input[type="text"], textarea').forEach(input => {
                input.value = '';
            });
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });
            document.getElementById('fileName').textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
        }

        // íƒ­ ì „í™˜
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(tabId).style.display = 'block';

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // ìš”ì²­ ì œì¶œ
        function submitRequest(event) {
            event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€
            // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
            const categoryIdx = document.querySelector('input[name="categoryIdx"]:checked');
            const userid = document.getElementById('userid').value;
            const emailId = document.getElementById('email').value;
            const emailDomain = document.getElementById('emailDomain').value;
            const applyTitle = document.getElementById('applyTitle').value;
            const applyContent = document.getElementById('applyContent').value;

            // ìœ íš¨ì„± ê²€ì‚¬
            let errorMessage = '';
            if (!categoryIdx) errorMessage += 'ì ê²€ ë¶„ì•¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.\n';
            if (!userid) errorMessage += 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n';
            if (!emailId) errorMessage += 'ì´ë©”ì¼ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n';
            if (!emailDomain) errorMessage += 'ì´ë©”ì¼ ë„ë©”ì¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n';
            if (!applyTitle) errorMessage += 'ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n';
            if (!applyContent) errorMessage += 'ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n';

            if (errorMessage) {
                alert(errorMessage);
                return;
            }

            // ëª¨ë“  í•„ë“œê°€ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥ëœ ê²½ìš° í¼ì„ ì œì¶œ
            document.querySelector('form').submit();
        }
    </script>
</div>
{% endblock %}
